<style>
    .detail-row-space .layui-row{
        margin-bottom: 5px;
    }
    #detailContainer td > .layui-table-cell{
        height:auto !important;
    }
</style>
<div class="layui-container detail-row-space" id="detailContainer">
<script type="text/html" id="data-ordersDetail">
        <div id="abstractInfo">
            <div style="margin: 10px auto">
                <button class="layui-btn" style="height: 50px;width: 100px;background-color:#eee;color:black;">{{item.orderInfo.orderStatusEnum}}</button>
            </div>
            <div style="margin: -55px 0px 0px 115px;">
                <span class="">订单流水号:{{item.orderInfo.orderId}}</span>
                <span style="color: red;">{{item.orderInfo.amountShow}}</span><br>
            </div>
            <div style="margin-left: 115px;">
                <span class="">{{item.orderInfo.departmentUserInfo}}</span>
                <span class="">{{item.orderInfo.seoUserName}}</span>
            </div>
        </div>
        {{if item.orderLink != null}}
            <div id="cunstomeInfo">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
                    <legend>客户信息</legend>
                </fieldset>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row">
                            <div class="layui-col-md3">
                                <div class="">姓:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.lastName}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">名:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.firstName}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">电话:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.telphone}}
                                    <span id="codeLable" onmouseleave="closeTips(this)"  onmouseenter="showTips(this)">
                                    {{if item.orderLink.codeType == '0'}}
                                        (验证成功)
                                    {{else if item.orderLink.codeType == '1'}}
                                        (验证失败)
                                    {{else}}
                                        (未验证)
                                    {{/if}}
                                    </span>
                                    <div id="showValidateCode"  style="display: none;width: 80px;border: solid 1px chocolate;padding-left: 10px;margin-left:80px;">
                                        <h5>原:{{item.orderLink.getCode}}</h5>
                                        <h5>验:{{item.orderLink.inputCode}}</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">邮箱</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class= "">{{item.orderLink.email}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">省（洲）:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.province}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">城市:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.city}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">区域:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.area}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">地址:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.address}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">邮编:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.zipcode}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">留言:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderLink.customerMeassage}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {{/if}}
        {{if item.orderInfo != null}}
            <div id="orderInfo">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>订单信息</legend>
                </fieldset>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row">
                            <div class="layui-col-md3">
                                <div class="">物流状态:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.trackingStatusShow}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row">
                            <div class="layui-col-md3">
                                <div class="">下单时间:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.purchaserAt}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">支付方式:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.paymentMethod}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">支付状态</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class= "">{{item.orderInfo.payState}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">域名:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.domain}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">来源:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.orderFrom}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">商家:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.merchantEnum}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">商家订单号:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.merchantOrderNo}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">地区:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.zoneName}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-row grid-demo layui-col-space15">
                            <div class="layui-col-md3">
                                <div class="">IP:</div>
                            </div>
                            <div class="layui-col-md9">
                                <div class="">{{item.orderInfo.ip}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {{/if}}
        <div id="skuInfo">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>商品信息</legend>
            </fieldset>
            {{if item.orderInfo != null}}
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md6">
                    <div class="layui-row grid-demo layui-col-space15">
                        <div class="layui-col-md3">
                            <div class="">下单数量:</div>
                        </div>
                        <div class="layui-col-md9">
                            <div class="">{{item.orderInfo.goodsQty}}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md3">
                    <div class="">套餐名:</div>
                </div>
                <div class="layui-col-md12">
                    {{item.orderInfo.comboName}}
                </div>
            </div>
            {{/if}}
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <table class="layui-table" id="orderItem">
                    </table>
                </div>
            </div>
        </div>
        <div id="remarKInfo">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>备注信息</legend>
            </fieldset>
            <form class="layui-form" action="" id="changeForm">
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <textarea name="remark" placeholder="请输入内容" maxlength="500" class="layui-textarea" value=""></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="addElementForm" id="addElementForm">保存</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="fsmHistorys">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>订单状态记录</legend>
            </fieldset>
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <table class="layui-table" id="fsmTable">
                    </table>
                </div>
            </div>
        </div>
</script>
</div>
<script type="text/html" id="newImgTpl">
    <div>
        <img src="{{window.product_img_host}}/{{d.productImageUrl}}"/>
    </div>
</script>

<script type="text/html" id="memoTpl">
    {{ layui.laytpl.fn( d.memo) }}
</script>

<script type="text/javascript">

    /*$(window).scroll(function(){
        var scrollTop = $(this).scrollTop();
        var scrollHeight = $(document).height();
        var windowHeight = $(this).height();
        if(scrollTop + windowHeight == scrollHeight){
            alert(1);
        }
    });*/
   var tip_index = "";
    layui.use(['layer','table','form'], function(){
        var form = layui.form;
        form.render();
        var table = layui.table;
        layui.laytpl.fn = function (value){
            return value.replace(new RegExp("\\*","gm"),"<br/>");
        }
        $.ajax({
            type : 'GET',
            url : "/orders/orders/order_abstract?orderId="+orderId,
            dataType : 'json',
            success : function(res){
                state_response(res);
                $("#detailContainer").html(template('data-ordersDetail', res));
                //方法渲染：
                table.render({
                    elem: '#orderItem'
                    ,id: 'orderItem',
                    data:res.item.orderItems,
                    cols: [[ //表头
                        {field: 'productImageUrl', height:150, width:150, title: '图片', toolbar: '#newImgTpl' }
                        ,{field: 'productId', title: '产品ID'}
                        ,{field: 'sku', title: 'SKU'}
                        ,{field: 'productTitle', title: '产品名称'}
                        ,{field: 'attrTitleArray', title: '产品属性'}
                        ,{field: 'qty', title: '数量'}
                       /* ,{field: 'singleAmount', title: '单价'}
                        ,{field: 'totalAmount', title: '小计'}*/
                    ]]
                });
                loadFsmHistory(table);
            }
        });

        form.on('submit(addElementForm)', function (data) {
            var newObj = data.field;
            newObj.orderId=orderId;
            $("#addElementForm").attr("disabled",true);
            $.ajax({
                type: 'POST',
                url: "/orders/orders/memo_update",
                data: {"orderId":newObj.orderId,"memo":newObj.remark},
                dataType: 'json',
                success: function (res) {
                    state_response(res);
                    layer.msg("备注保存成功");
                    $('#addElementForm').removeAttr("disabled");
                    loadFsmHistory(table);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $('#addElementForm').removeAttr("disabled");
                    layer.msg("备注保存失败");
                }
            });
            return false;
        });

    });

    function showTips(that){
        tip_index = layer.tips($('#showValidateCode').html(), that); //在元素的事件回调体中，follow直接赋予this即可
    }
    function closeTips(){
        layer.close(tip_index);//在元素的事件回调体中，follow直接赋予this即可
    }
    function  loadFsmHistory(table) {
        table.render({
            elem: '#fsmTable',
            id: 'fsmTable',
            method: 'get',
            url:  "/orders/orders/queryFsmHistory?orderId="+orderId,
            page: true,
            even:true,
            limit: 10
            , request: {
                pageName: 'page' //页码的参数名称，默认：page
                ,limitName: 'limit' //每页数据量的参数名，默认：limit
            } ,
            response: {
                statusName: 'code' //数据状态的字段名称，默认：code
                , statusCode: 'OK' //成功的状态码，默认：0
                , msgName: 'desc' //状态信息的字段名称，默认：msg
                , countName: 'total' //数据总数的字段名称，默认：count
                , dataName: 'item' //数据列表的字段名称，默认：data
            },cols: [[ //表头
                {field: 'srcStateDisplay', title: '原始状态',width:"15%"}
                ,{field: 'dstStateDisplay', title: '目标状态',width:"15%"}
                ,{field: 'optUid', title: '用户',width:"15%"}
                , {title: '详细',templet: '#memoTpl'}
                ,{field: 'createAt', title: '时间',width:"20%"}
            ]]
        });
    }
</script>
